<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Chat Sample(Multi) | SkyWay</title>
<meta name="author" content="作成者">
<meta name="copyright" content="Copyright (C) ">
<meta name="description" content="サイト説明文">
<meta name="keywords" content="キーワード,,,,">
<meta http-equiv="Content-Style-Type" content="text/css; charset=UTF-8">
<meta http-equiv="Content-Script-Type" content="text/javascript; charset=UTF-8">
<meta http-equiv="imagetoolbar" content="no">
<link rel="shortcut icon" href="favicon.ico">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="https://skyway.io/dist/0.3/peer.js"></script>
<style type="text/css">
* { margin: 0; padding: 0; color: #333333; }
body { margin: 50px; font-size: 12px; }
h1 { font-size: 14px; }
</style>
</head>
<body>

  <div class="container">
    <h1>
      <small>My ID: </small>
      <span id="myId"></span>
    </h1>
    <div class="connected"></div>
    <div class="messages">
      <input id="message"></input>
      <span id="sendMessage" class="btn btn-primary">Send</span>
      <div id="messageData"></div>
    </div>
  </div>
	
<script>
$(function(){
  
  var API_KEY = 'd74ba527-b70f-4011-b70c-b2068bbb9038';
  var peer = new Peer({key: API_KEY});
  var connectedPeer = {}; // 接続した事があるPeer(切断したPeerも含め全て)
  var timerId; // 定期的な接続チェック用タイマー
  var TIMER_NUM = 3000; // 3秒に1回チェック

  // new Peerして、Peerオブジェクト生成されたら。
  // 引数のidで生成されたランダムなidが発行されるので、それを使ってpeer.connectする
  peer.on('open', function(id) {
    console.log('My peer ID is: ' + id);
    $('#myId').text(id);
    myId = id;
    
    // 定期的タイマースタート
    peerCheck();
  });
  
  // 他のPeerから接続があった時
  peer.on('connection', function(conn) {
    connect(conn);
  });
  
  // メッセージを追加
  var inputMessage = function(id, message) {
    $('#messageData').prepend($('<div/>').text(id + ': ' + message));
  };
  
  // connect
  var connect = function(conn) {
    // 一度も繋いでないPeerだったら
    if(!connectedPeer[conn.peer]) {
      // $('.connected').prepend($('<div/>').text('ID: ' + conn.peer + 'と通信中'));
      
      conn.on('data', function(data){
        var id = data.ids[0];
        var message = data.message;
        inputMessage(id, message);
        
        conn.on('close', function() {
          console.log(conn.peer + ' has left the chat.');
          delete connectedPeer[conn.peer];
        });
      });
    }
    connectedPeer[conn.peer] = 1;
  };
  
  // 定期的にPeer接続先がないかチェックして、あったら接続する
  var peerCheck = function () {
    console.log('PeerCheck!');
    
    // APIキー毎のアクティブなPeerIDを取得(PeerIDがlistに配列で格納される)
    peer.listAllPeers(function(list){
      var connectPeerText = '';
      
      for(var i=0, l=list.length; i < l; i++){
        // 一度も繋いでなく、自分自身のIDじゃなかったら
        if(!connectedPeer[list[i]] && myId !== list[i]) {
          var conn = peer.connect(list[i]);
          conn.on('open', function(){
            connect(conn);
          });
          conn.on('error', function(err) { console.log(err); });
        }
        
        if(myId !== list[i]) {
          connectPeerText += 'ID: ' + list[i] + 'と通信中<br>';
        }
      }
      
      // 接続中のIDを表示する
      $('.connected').html(connectPeerText);
    });
    
    // 定期チェック
    timerId = setTimeout(function(){
      peerCheck();
    }, TIMER_NUM);
  };
  
  // メッセージ送信時
  $('#sendMessage').click(function() {
    var text = $('#message').val();
    $('#message').val('');
    if(text === '') return;
    $.each(peer.connections, function(_id, _conn) {
      _conn[0].send({
        message: text,
        ids: [myId]
      });
    });
    inputMessage(myId, text);
  });
  
  window.onunload = window.onbeforeunload = function(e) {
    if (!!peer && !peer.destroyed) {
      peer.destroy();
    }
  };
  
});
</script>
</body>
</html>
